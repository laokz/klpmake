# KLPMAKE

In trying auto generate livepatch module source and adding loaded-module patching support, data object `Livepatch Symbols` support, etc. The code looks very ugly now.

Inspired by KPATCH @ https://github.com/dynup/kpatch. Many thanks!

Klpmake is a Linux kernel livepatch making tool. It calls toolchain to make the patching source to "partial linked" object, which included `Livepatch Symbols -- non-exported global symbols and non-included local symbols`, then fixes these symbols to respect [Livepatch module ELF format](https://www.kernel.org/doc/html/latest/livepatch/module-elf-format.html) and generates a normal kernel module.

Klpmake auto-generate livepatch source according to `samples/livepatch/livepatch-sample.c` style, based on patch file. Then resolves the `Livepatch Symbols` reliably through vmlinux DWARF infomation and `/proc/kallsyms`. It doesn't compile the kernel source nor hacking the ELF too deeply, and nearly nothing architecture specific.

It's fast, simple and small.

### Usage

##### Requires and Compile

libdwarf(>=0.8.0) libclang elfutils-libelf(gelf) bash

Different OS distribution may have different install directory. Now the code if for openEuler.

Compile: `make`

##### Run

KLPMAKE needs query vmlinux's DWARF information, ensure corresponding compiler options enabled. Put the patch file in the working directory, and provide a klpsrc.conf file like the .sample, then
```
sudo klpmake-dir/klpmake
```

Actually, Klpmake does the work by two steps.
 - 1. `klpmake 1`, Generate livepatch source. You can check and modify the source code. Also this step generate a `_klpmake.syms` which has `Livepatch Symbols` positions information. It can also be modified.
 - 2. `klpmake 2`, compile and fix livepatch module. Except `Livepatch Symbols` ELF info fix, nothing differnet with normal module make.

### Genarated Files

- *.c			source before patch
- livepatch.c		livepatch main source
- Makefile			libepatch Makefile
- _klpmake.syms		Livepatch Symbols positions，generated by klpsrc，used by fixklp

### Examples

See [example](example/readme.md). Haven't update yet. If did, there would have klpsrc.conf, .patch in every example.

### Limits

Not respected `KSYM_NAME_LEN(512)`. If symbol name no more 200, nothing bad.

If vmlinux DWARF info incomplete or broken, the tool would not work normally.

The tool is developed and test on riscv64, and it's just on the first step.

Welcome to try and feedback. Welcome contribution.

