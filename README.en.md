# KLPMAKE

Inspired by KPATCH @ https://github.com/dynup/kpatch. Many thanks!

KLPMAKE is a Linux kernel livepatch making tool. It calls toolchain to make the patching source to "partial linked" object, which included `Livepatch Symbols -- non-exported global symbols and non-included local symbols`, then fixes these symbols to respect [Livepatch module ELF format](https://www.kernel.org/doc/html/latest/livepatch/module-elf-format.html) and generates a normal kernel module.

Developers can write patch according to `samples/livepatch/livepatch-sample.c` style. KLPMAKE resolves the `Livepatch Symbols` reliably through vmlinux DWARF infomation and `/proc/kallsyms`. It doesn't compile the kernel source nor hacking the ELF too deeply, and nearly nothing architecture specific.

It's fast, simple and small. But note it doesn't support livepatching loadable modules, ONLY the current running kernel with vmlinux.

### Usage

##### Requires

libdwarf-tools(dwarfdump) elfutils-libelf(gelf) bash modpost

The tool depends on symbols information generated by kernel/scripts/modpost. To avoid these been suppressed, we need recompile modpost.
```
--- scripts/mod/modpost.c.orig	2023-11-17 20:43:14.589757214 +0800
+++ scripts/mod/modpost.c	2023-11-17 20:43:40.114101691 +0800
@@ -46,7 +46,7 @@
  * Cut off the warnings when there are too many. This typically occurs when
  * vmlinux is missing. ('make modules' without building vmlinux.)
  */
-#define MAX_UNRESOLVED_REPORTS	10
+#define MAX_UNRESOLVED_REPORTS	50
 static unsigned int nr_unresolved;

 /* In kernel, this size is defined in linux/module.h;
```
```
cd scripts/mod
gcc -o modpost modpost.c file2alias.c sumversion.c
```

##### Run

KLPMAKE needs query vmlinux's DWARF information, ensure corresponding compiler options enabled. In patches directory, run
```
sudo KLPMAKE_VMLINUX=path-to-vmlinux klpmake-dir/klpmake
```

`KLPMAKE_VMLINUX` default to `/usr/lib/debug/lib/modules/$(uname -r)/vmlinux`.

When the target buggy function is a `static`, please run `kallsympos` first to locate its symbol position and write in the patch source.

`_klpmake.syms` is generated by KLPMAKE to save `Livepatch Symbols` positions. Anytime you can check and verify them.

### Patch source

To let KLPMAKE work, patch source should obey some rules.

1. Organize the patch sources ono-to-one relating to original kernel sources.
2. Add a solo comment line `//KLPMAKE kernel-source-path`, named tag. Kernel source path is relative to source tree root.
3. When there are multipul patch sources, only one is the main file and containing all the livepatch elements.
4. When referenced an untouched "static" in the patch function, put its prototype in the source with "static" keyword preserved.
5. When referenced function was inlined by compiler, expand or put it body all in the source.
6. When patch functions in other files, they must be defined as globals, and in main file you should add `extern` declarions for them.

Complicated hnn? No worry. Lots of them are common for kernel developers and KLPMAKE can hint you time by time also.

### Examples

See [example](example/readme.md).

Note, all the examples were targeted at [openEuler](https://openeuler.org/) riscv64 OS and its CONFIG_LIVEPATCH_WO_FTRACE mechanism.

### Limits

Not considered data object `Livepatch Symbols`.

Not respected `KSYM_NAME_LEN(512)`. If symbol name no more 200, nothing bad.

KLPMAKE depends on some messages produced by a little tools. By now I only used  the followings, gcc 12.3.1, ld 2.40, dwarfdump 0.7.0(DWARF v4), kallsyms and modpost(kernel 6.4). See the scripts.

If vmlinux DWARF info incomplete or broken, the tool would not work normally.

The tool is developed and test on riscv64, and it's just on the first step.

Welcome to try and feedback. Welcome contribution.

